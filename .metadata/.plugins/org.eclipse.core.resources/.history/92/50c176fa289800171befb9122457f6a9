package main;

import java.util.List;
import java.util.ArrayList;
import java.util.Scanner;

import behaviors.MatchBirthAndMotherAlgorithm;
import behaviors.MatchIdentifiersAlgorithm;
import behaviors.MatchNameAlgorithm;
import behaviors.ReadInputBehavior;
import behaviors.ReadJSONFile;
import behaviors.ReadXMLFile;
import behaviors.ReportResultsToConsole;
import behaviors.ReportResultsToFile;

public class Client {
	
	public static void main(String[] args) {
		introMessage();
		
		Scanner s = new Scanner(System.in);
		String input = "";
		boolean loop = true;
		while (loop) {
			System.out.print("$ ");
			input = s.nextLine();
			String[] inputArgs = input.split("\\s+");
			String outputFile = "", inputFile = "", extension = "";
			Person[] people = {};
			
			if (inputArgs[0].equals("PM") && inputArgs.length >= 3) {
				inputFile = inputArgs[2].toString();
				PersonMatcher pm = new PersonMatcher();
				ReadInputBehavior behavior;
				
				// Get file type extension
				int i = inputFile.lastIndexOf('.');
				if (i > 0) {
				    extension = inputFile.substring(i+1);
				}
				
				if (extension.equals("json")) {
					pm.setReadBehavior(new ReadJSONFile());
				} else if (extension.equals("xml")){
					pm.setReadBehavior(new ReadXMLFile());
				}
				// Read people from input file.
				people = pm.executeReadBehavior(inputArgs[2]);
				
				if (inputArgs[1].equals("1")) {
					pm.setMatchAlgorithmBehavior(new MatchNameAlgorithm());
				} else if (inputArgs[1].equals("2")) {
					pm.setMatchAlgorithmBehavior(new MatchBirthAndMotherAlgorithm());
				} else if (inputArgs[1].equals("3")) {
					pm.setMatchAlgorithmBehavior(new MatchIdentifiersAlgorithm());
				}
				
				MatchPair[] matchedPairs = runMatchAlgorithm(people, pm);
				printMatchPairArray(matchedPairs);
				
				if (inputArgs.length > 3)
					pm.setResultReportingBehavior(new ReportResultsToConsole());
				else
					pm.setResultReportingBehavior(new ReportResultsToFile());
				
				pm.executeReportingBehavior();
				
			} else if (inputArgs[0].equals("exit") || inputArgs[0].equals("Exit")) {
				loop = false;
			}
		}
		System.out.println("PersonMatcher program terminated.");
	}

	public static MatchPair[] runMatchAlgorithm(Person[] people, PersonMatcher pm) {
		
		List<MatchPair> listPairs = new ArrayList<MatchPair>();
		List<MatchPair> listMatches = new ArrayList<MatchPair>();
		
		// It doesn't like this 
		for (int i = 1; i < people.length; i++) { 
			for (int j = (people.length-i); j > 0; j--) {
				listPairs.add(new MatchPair(people[i-1], people[(people.length-j)]));
			}
		}
		MatchPair[] uniquePairs = listPairs.toArray(new MatchPair[listPairs.size()]);
		
		for (int i = 0; i < uniquePairs.length; i++) {
			if (pm.executeAlgorithmBehavior(uniquePairs[i])) {
				listMatches.add(uniquePairs[i]);
			}
		}
		MatchPair[] matches = listMatches.toArray(new MatchPair[listMatches.size()]);
		
		return matches;
	}
	
	public static void introMessage() {
		System.out.println("Person Matcher program started!");
		System.out.println("The available matching algorithms can be run by using numbers below:");
		System.out.println("1 - PM Algorithm");
		System.out.println("ex: \'$ PersonMatcher 1 JSON_PersonTestSet_3.json Results.txt\',\nwould be a valid command.");
		System.out.println("Enter \'exit\' at any time to terminate the program.");
	}
	
	// This is for me
	public static void printMatchPairArray(MatchPair[] mp) {
		if (mp.length != 0) {
			for (int i = 0; i < mp.length; i++) {
				System.out.println("P1");
				mp[i].getP1().printPersonToConsole();
				System.out.println("P2");
				mp[i].getP2().printPersonToConsole();
			}
		} else {
			System.out.println("empty array");
		}
	}
	
	// this is for me
	public static void printPersonArray(Person[] p) {
			for (int i = 0; i < p.length; i++) {
				p[i].printPersonToConsole();
			}
	}
}
